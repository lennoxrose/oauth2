<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/x-icon" href="../assets/icon.ico" />
    <title>Processing Verification...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        accent: '#9CA3AF'
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="../style.css" />
</head>
<body class="bg-black text-gray-200 antialiased">
    <main class="mx-auto max-w-6xl px-3 sm:px-6 lg:px-8 min-h-screen flex items-center justify-center py-16">
        <div id="loading-section" class="w-full max-w-2xl text-center">
            <div class="inline-flex items-center justify-center w-24 h-24 mb-6 border border-white/10 bg-black/40">
                <div class="loading">
                    <svg class="w-12 h-12 text-accent animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
            </div>
            
            <h1 class="text-4xl sm:text-5xl font-extrabold leading-tight tracking-tight text-white mb-4">
                Verifying <span class="text-accent">Account...</span>
            </h1>
            
            <p class="text-gray-300">Please wait while we process your verification</p>
        </div>

        <div id="success-section" class="w-full max-w-2xl text-center hidden">
            <div class="inline-flex items-center justify-center w-24 h-24 mb-6 border border-white/10 bg-black/40">
                <span class="text-5xl">✅</span>
            </div>
            
            <h1 class="text-4xl sm:text-5xl font-extrabold leading-tight tracking-tight text-white mb-4">
                Verification <span class="text-accent">Successful!</span>
            </h1>
            
            <div id="user-info" class="mt-8 border border-white/10 p-6">
                <!-- User info will be inserted here -->
            </div>

            <p class="mt-6 text-gray-300">
                You can now close this page and return to Discord.
            </p>
        </div>

        <div id="error-section" class="w-full max-w-2xl text-center hidden">
            <div class="inline-flex items-center justify-center w-24 h-24 mb-6 border border-white/10 bg-black/40">
                <span class="text-5xl">❌</span>
            </div>
            
            <h1 class="text-4xl sm:text-5xl font-extrabold leading-tight tracking-tight text-white mb-4">
                Verification <span class="text-red-400">Failed</span>
            </h1>
            
            <div id="error-message" class="mt-8 border border-red-500/20 p-6 bg-red-500/5">
                <p class="text-red-400">An error occurred during verification.</p>
            </div>

            <button onclick="window.location.href='/oauth2/'" class="mt-6 px-8 py-4 bg-accent text-black font-semibold border border-accent hover:bg-transparent hover:text-accent transition-colors">
                Try Again
            </button>
        </div>
    </main>
    
    <script>
        let API_BASE = null;

        // Load configuration from server
        async function loadConfig() {
            try {
                const response = await fetch('/oauth2/config.php');
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to load configuration');
                }
                const config = await response.json();
                API_BASE = config.api_base;
                console.log('Config loaded:', config);
            } catch (error) {
                console.error('Configuration error:', error);
                showError('Configuration error: ' + error.message);
                throw error;
            }
        }

        async function handleCallback() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const error = params.get('error');

            if (error) {
                showError(error);
                return;
            }

            if (!code) {
                showError('No authorization code received');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/callback`, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ code })
                });

                // Log the raw response for debugging
                const responseText = await response.text();
                console.log('Raw response:', responseText);
                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));

                // Try to parse JSON
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error. Raw response:', responseText);
                    throw new Error('Server returned invalid JSON. Check console for details.');
                }

                if (!response.ok) {
                    throw new Error(data.error || 'Verification failed');
                }

                if (data.success && data.user) {
                    showSuccess(data.user);
                } else {
                    throw new Error('Invalid response from server');
                }
            } catch (err) {
                console.error('Callback error:', err);
                showError(err.message);
            }
        }

        function showSuccess(user) {
            document.getElementById('loading-section').classList.add('hidden');
            document.getElementById('error-section').classList.add('hidden');
            
            const successSection = document.getElementById('success-section');
            successSection.classList.remove('hidden');

            const avatar = user.avatar 
                ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`
                : `https://cdn.discordapp.com/embed/avatars/${parseInt(user.discriminator) % 5}.png`;

            document.getElementById('user-info').innerHTML = `
                <h2 class="text-xl font-bold text-white mb-4">Your Account</h2>
                <div class="flex items-center gap-4 justify-center">
                    <img src="${avatar}" class="w-16 h-16 border border-white/10" alt="User Avatar">
                    <div class="text-left">
                        <p class="text-white font-semibold">${user.username}${user.discriminator !== '0' ? '#' + user.discriminator : ''}</p>
                        <p class="text-gray-400 text-sm">ID: ${user.id}</p>
                    </div>
                </div>
            `;
        }

        function showError(message) {
            document.getElementById('loading-section').classList.add('hidden');
            document.getElementById('success-section').classList.add('hidden');
            
            const errorSection = document.getElementById('error-section');
            errorSection.classList.remove('hidden');
            
            document.getElementById('error-message').innerHTML = `
                <p class="text-red-400">${message}</p>
            `;
        }

        // Start callback handling
        (async () => {
            await loadConfig();
            handleCallback();
        })();
    </script>
</body>
</html>
