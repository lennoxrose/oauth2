<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Processing Login...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        accent: '#9CA3AF'
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="../../style.css" />
</head>
<body class="bg-black text-gray-200 antialiased">
    <main class="mx-auto max-w-6xl px-3 sm:px-6 lg:px-8 min-h-screen flex items-center justify-center py-16">
        <div id="loading-section" class="w-full max-w-2xl text-center">
            <div class="inline-flex items-center justify-center w-24 h-24 mb-6 border border-white/10 bg-black/40">
                <div class="loading">
                    <svg class="w-12 h-12 text-accent animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
            </div>
            
            <h1 class="text-4xl sm:text-5xl font-extrabold leading-tight tracking-tight text-white mb-4">
                Authenticating...
            </h1>
            
            <p class="text-gray-300">Please wait while we verify your identity</p>
        </div>

        <div id="error-section" class="w-full max-w-2xl text-center hidden">
            <div class="inline-flex items-center justify-center w-24 h-24 mb-6 border border-white/10 bg-black/40">
                <span class="text-5xl">‚ùå</span>
            </div>
            
            <h1 class="text-4xl sm:text-5xl font-extrabold leading-tight tracking-tight text-white mb-4">
                Access <span class="text-red-400">Denied</span>
            </h1>
            
            <div id="error-message" class="mt-8 border border-red-500/20 p-6 bg-red-500/5">
                <p class="text-red-400">You are not authorized to access this dashboard.</p>
            </div>

            <a href="/admin/" class="inline-block mt-6 px-8 py-4 bg-accent text-black font-semibold border border-accent hover:bg-transparent hover:text-accent transition-colors">
                Back to Login
            </a>
        </div>
    </main>
    
    <script>
        const ADMIN_USER_ID = '1306175435486400546';
        const ADMIN_API = 'https://api.lennox-rose.com/v2/oauth2/discord/admin';

        async function handleCallback() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const error = params.get('error');

            if (error) {
                showError('Authorization failed: ' + error);
                return;
            }

            if (!code) {
                showError('No authorization code received');
                return;
            }

            try {
                // Call our PHP backend to exchange code for token
                console.log('Calling admin API:', ADMIN_API);
                console.log('Code:', code);
                
                const response = await fetch(ADMIN_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code })
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                
                const responseText = await response.text();
                console.log('Raw response:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    throw new Error('Invalid JSON response: ' + responseText);
                }
                
                if (!response.ok) {
                    throw new Error(data.error || 'Authentication failed');
                }

                if (!data.success) {
                    throw new Error('Invalid response from server');
                }

                const user = data.user;
                
                // No need to check ADMIN_USER_ID here - the API already validated the user
                // is in the admin_permissions table

                // Store session
                const session = {
                    user_id: user.id,
                    username: user.username,
                    avatar: user.avatar,
                    access_token: user.access_token,
                    expires: Date.now() + (7 * 24 * 60 * 60 * 1000) // 7 days
                };

                localStorage.setItem('admin_session', JSON.stringify(session));
                
                // Redirect to dashboard
                window.location.href = '/admin/dashboard/';

            } catch (err) {
                console.error('Callback error:', err);
                showError(err.message);
            }
        }

        function showError(message) {
            document.getElementById('loading-section').classList.add('hidden');
            document.getElementById('error-section').classList.remove('hidden');
            document.getElementById('error-message').innerHTML = `<p class="text-red-400">${message}</p>`;
        }

        handleCallback();
    </script>
</body>
</html>
