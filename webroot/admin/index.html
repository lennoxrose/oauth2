<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        accent: '#9CA3AF'
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="style.css" />
</head>
<body class="bg-black text-gray-200 antialiased">
    <main class="mx-auto max-w-6xl px-3 sm:px-6 lg:px-8 min-h-screen flex items-center justify-center py-16">
        <div class="w-full max-w-md text-center">
            <div class="inline-flex items-center justify-center w-24 h-24 mb-6 border border-white/10 bg-black/40">
                <span class="text-5xl">üîê</span>
            </div>
            
            <h1 class="text-4xl sm:text-5xl font-extrabold leading-tight tracking-tight text-white mb-4">
                Admin <span class="text-accent">Dashboard</span>
            </h1>
            
            <p class="text-gray-300 mb-8">
                Login with Discord to access the admin panel
            </p>

            <a href="#" id="login-button" class="inline-block px-8 py-4 bg-accent text-black font-semibold border border-accent hover:bg-transparent hover:text-accent transition-colors">
                Login with Discord
            </a>

            <div id="error-message" class="mt-6 border border-red-500/20 p-4 bg-red-500/5 hidden">
                <p class="text-red-400">Unauthorized - Only authorized users can access this dashboard.</p>
            </div>
        </div>
    </main>
    
    <script src="js/config.js"></script>
    <script>
        async function initLogin() {
            try {
                // Load configuration
                const config = await window.getConfig();
                
                // Fetch bot settings from API to get CLIENT_ID
                const settingsResponse = await fetch(`${config.API_BASE}/settings`, {
                    headers: {
                        'Authorization': `Bearer ${config.API_SECRET}`
                    }
                });
                
                if (!settingsResponse.ok) {
                    throw new Error('Failed to load bot settings');
                }
                
                const settingsData = await settingsResponse.json();
                console.log('Raw settings data:', settingsData);
                
                // Settings API returns nested format: { setting_key: { value, type, description } }
                const CLIENT_ID = settingsData.client_id?.value || settingsData.client_id;
                const ADMIN_REDIRECT_URI = settingsData.admin_redirect_uri?.value || settingsData.admin_redirect_uri;
                
                // Use the stored redirect URI or construct one
                const REDIRECT_URI = ADMIN_REDIRECT_URI || `https://${window.location.hostname}/admin/callback/`;
                
                console.log('Login config:', { CLIENT_ID, REDIRECT_URI });
                
                document.getElementById('login-button').addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    const authUrl = `https://discord.com/oauth2/authorize?` + new URLSearchParams({
                        client_id: CLIENT_ID,
                        redirect_uri: REDIRECT_URI,
                        response_type: 'code',
                        scope: 'identify'
                    });
                    
                    window.location.href = authUrl;
                });
                
            } catch (error) {
                console.error('Failed to initialize login:', error);
                document.getElementById('error-message').innerHTML = '<p class="text-red-400">Configuration error - please contact administrator</p>';
                document.getElementById('error-message').classList.remove('hidden');
            }
        }
        
        // Initialize login
        initLogin();
        
        // Check if already logged in
        const session = localStorage.getItem('admin_session');
        if (session) {
            const data = JSON.parse(session);
            // Check if session is still valid (don't check ADMIN_USER_ID - let the API validate)
            if (data.expires > Date.now()) {
                window.location.href = '/admin/dashboard/';
            }
        }
    </script>
</body>
</html>
